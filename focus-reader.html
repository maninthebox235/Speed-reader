<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Levi's Focus Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --control-bg: rgba(30, 30, 30, 0.8);
            --pivot-color: #ff4444;
        }
        .theme-light {
            --bg-color: #f5f5f5;
            --text-color: #222222;
            --control-bg: rgba(255, 255, 255, 0.9);
        }
        .theme-sepia {
            --bg-color: #f4ecd8;
            --text-color: #5b4636;
            --control-bg: rgba(244, 236, 216, 0.9);
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
            transition: background 0.3s, color 0.3s;
        }
        #controls {
            position: fixed;
            bottom: 20px;
            width: 90%;
            max-width: 800px;
            background: var(--control-bg);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        #display {
            font-size: 72px;
            font-weight: bold;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            cursor: pointer;
        }
        input, button, select {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }
        #wpm-slider {
            width: 200px;
        }
        progress {
            width: 300px;
            height: 10px;
        }
        #inputs {
            position: fixed;
            top: 20px;
            width: 90%;
            max-width: 800px;
        }
        #inputs.dragover {
            border: 3px dashed var(--pivot-color, #ff4444);
            border-radius: 12px;
            background: rgba(255, 68, 68, 0.1);
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            body {
                height: 100dvh; /* Dynamic viewport height for mobile browsers */
            }
            #display {
                font-size: 48px;
                height: 120px;
                padding: 0 10px;
                word-break: break-word;
            }
            #inputs {
                top: 10px;
                padding: 10px;
            }
            #inputs textarea {
                width: 100%;
                box-sizing: border-box;
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
            #controls {
                bottom: 10px;
                padding: 10px;
                max-height: 60vh;
                overflow-y: auto;
            }
            input, button, select {
                margin: 4px;
                padding: 12px 8px;
                font-size: 14px;
                min-height: 44px; /* Touch-friendly target size */
            }
            #wpm-slider {
                width: 120px;
            }
            progress {
                width: 90%;
                max-width: 280px;
            }
            .mobile-row {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 4px;
                margin: 4px 0;
            }
            #font-size {
                width: 60px !important;
            }
            #ramp-controls input {
                width: 50px !important;
            }
            .keyboard-hint {
                display: none !important; /* Hide keyboard shortcuts on mobile */
            }
            .mobile-hint {
                display: inline !important; /* Show mobile hints */
            }
        }

        @media (max-width: 480px) {
            #display {
                font-size: 36px;
                height: 100px;
            }
            input, button, select {
                margin: 3px;
                padding: 10px 6px;
                font-size: 13px;
            }
            #wpm-slider {
                width: 100px;
            }
        }

        /* Prevent text selection on touch */
        * {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body>
    <div id="inputs">
        <textarea id="text-input" rows="4" cols="50" placeholder="Paste text here or drag & drop a file..."></textarea><br>
        <input type="file" id="file-upload" accept=".txt,.pdf">
        <button onclick="loadText()">Load Text</button>
        <button onclick="toggleLibrary()">Library</button>
        <button onclick="toggleStats()">Stats</button>
        <div id="library-panel" style="display:none; margin-top:10px; padding:10px; background:rgba(128,128,128,0.2); border-radius:8px; max-height:150px; overflow-y:auto;">
            <strong>Your Library</strong>
            <div id="library-list"></div>
        </div>
        <div id="stats-panel" style="display:none; margin-top:10px; padding:10px; background:rgba(128,128,128,0.2); border-radius:8px;">
            <strong>Reading Statistics</strong>
            <div id="stats-content"></div>
            <button onclick="clearStats()" style="margin-top:10px; padding:4px 8px; font-size:12px;">Clear Stats</button>
        </div>
    </div>

    <div id="display"></div>

    <div id="controls" style="display:none;">
        <button onclick="skipBack()">&lt;&lt; -10</button>
        <button onclick="togglePlay()">Play</button>
        <button onclick="skipForward()">+10 &gt;&gt;</button>
        <button onclick="reset()">Reset</button>
        <button onclick="saveToLibrary()">Save</button>
        <button onclick="toggleFullscreen()">Fullscreen</button>
        <select id="theme-select">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
            <option value="sepia">Sepia</option>
        </select><br>
        <label>WPM: <span id="wpm-value">500</span></label>
        <input type="range" id="wpm-slider" min="100" max="1000" step="50" value="500">
        <label>Words:
            <select id="chunk-select">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
        </label>
        <label><input type="checkbox" id="auto-ramp"> Auto-ramp</label>
        <span id="ramp-controls" style="display:none;">
            <input type="number" id="start-wpm" value="200" min="100" max="1000" style="width:60px;">
            to <input type="number" id="target-wpm" value="600" min="100" max="1000" style="width:60px;"> WPM
        </span>
        <label>Size: <input type="range" id="font-size" min="36" max="120" value="72" style="width:80px;"></label>
        <select id="font-family">
            <option value="'Segoe UI', sans-serif">Segoe UI</option>
            <option value="Georgia, serif">Georgia</option>
            <option value="'Courier New', monospace">Courier</option>
            <option value="Arial, sans-serif">Arial</option>
        </select>
        <label>Pivot: <input type="color" id="pivot-color" value="#ff4444"></label><br>
        <div id="progress-container" style="display:inline-block; cursor:pointer; position:relative;">
            <progress id="progress" value="0" max="100"></progress>
        </div><br>
        <span id="info">Words: 0 | Time left: --</span><br>
        <span class="keyboard-hint" style="font-size: 12px; color: #888;">Space: Play/Pause | Left/Right: Speed | Up/Down: Skip | R: Reset</span>
        <span class="mobile-hint" style="font-size: 12px; color: #888; display: none;">Tap: Play/Pause | Swipe: Skip</span>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let words = [];
        let currentIndex = 0;
        let timer = null;
        let isPlaying = false;
        let wpm = 500;
        let chunkSize = 1;
        let autoRamp = false;
        let startWpm = 200;
        let targetWpm = 600;
        let fontSize = 72;
        let fontFamily = "'Segoe UI', sans-serif";
        let pivotColor = '#ff4444';
        let currentTextId = null;
        let library = JSON.parse(localStorage.getItem('focusReaderLibrary') || '[]');
        let readingStats = JSON.parse(localStorage.getItem('focusReaderStats') || '{"totalWordsRead":0,"totalTimeMs":0,"sessions":[]}');
        let sessionStartTime = null;
        let sessionStartIndex = 0;

        function getPivotPosition(len) {
            if (len <= 1) return 0;
            if (len <= 5) return 1;
            if (len <= 9) return 2;
            if (len <= 13) return 3;
            return 4;
        }

        function displayWord(word) {
            if (!word) return '';
            const len = word.length;
            const pivot = getPivotPosition(len);
            const left = word.slice(0, pivot);
            const center = word[pivot];
            const right = word.slice(pivot + 1);
            return `${left}<span style="color:${pivotColor};">${center}</span>${right}`;
        }

        function displayChunk(wordsArr) {
            if (wordsArr.length === 1) return displayWord(wordsArr[0]);
            // For multiple words, highlight the pivot of the middle word
            const midIndex = Math.floor(wordsArr.length / 2);
            return wordsArr.map((word, i) => {
                if (i === midIndex) return displayWord(word);
                return word;
            }).join(' ');
        }

        function getCurrentWpm() {
            if (!autoRamp || words.length === 0) return wpm;
            // Linear ramp from startWpm to targetWpm based on progress
            const progress = currentIndex / words.length;
            return Math.round(startWpm + (targetWpm - startWpm) * progress);
        }

        function getDelayForWord(word) {
            const currentWpm = getCurrentWpm();
            const baseDelay = 60000 / currentWpm;
            if (!word) return baseDelay;
            const lastChar = word[word.length - 1];
            // Longer pause for sentence endings
            if (['.', '!', '?'].includes(lastChar)) return baseDelay * 2;
            // Medium pause for clause breaks
            if ([',', ';', ':', '-', 'â€”'].includes(lastChar)) return baseDelay * 1.5;
            return baseDelay;
        }

        function showWord() {
            const display = document.getElementById('display');
            if (currentIndex < words.length) {
                // Get chunk of words
                const chunk = words.slice(currentIndex, currentIndex + chunkSize);
                display.innerHTML = displayChunk(chunk);
                currentIndex += chunkSize;
                updateProgress();
                // Schedule next word with variable delay (based on last word in chunk)
                if (isPlaying) {
                    const lastWord = chunk[chunk.length - 1];
                    timer = setTimeout(showWord, getDelayForWord(lastWord) * chunkSize);
                }
            } else {
                stop();
                display.innerHTML = '(Finished)';
            }
        }

        function start() {
            if (words.length === 0 || currentIndex >= words.length) return;
            if (timer) clearTimeout(timer);
            isPlaying = true;
            sessionStartTime = Date.now();
            sessionStartIndex = currentIndex;
            document.querySelector('button[onclick="togglePlay()"]').textContent = 'Pause';
            showWord();
        }

        function stop() {
            if (timer) clearTimeout(timer);
            timer = null;
            isPlaying = false;
            document.querySelector('button[onclick="togglePlay()"]').textContent = 'Play';
            saveCurrentPosition(); // Auto-save position when stopping

            // Track reading session
            if (sessionStartTime && currentIndex > sessionStartIndex) {
                const wordsRead = currentIndex - sessionStartIndex;
                const timeMs = Date.now() - sessionStartTime;
                const avgWpm = Math.round((wordsRead / timeMs) * 60000);

                readingStats.totalWordsRead += wordsRead;
                readingStats.totalTimeMs += timeMs;
                readingStats.sessions.push({
                    date: Date.now(),
                    wordsRead,
                    timeMs,
                    avgWpm
                });
                // Keep only last 50 sessions
                if (readingStats.sessions.length > 50) {
                    readingStats.sessions = readingStats.sessions.slice(-50);
                }
                localStorage.setItem('focusReaderStats', JSON.stringify(readingStats));
            }
            sessionStartTime = null;
        }

        function toggleLibrary() {
            const panel = document.getElementById('library-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                updateLibraryUI();
            }
        }

        function toggleStats() {
            const panel = document.getElementById('stats-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                updateStatsUI();
            }
        }

        function updateStatsUI() {
            const statsContent = document.getElementById('stats-content');
            const totalMinutes = Math.round(readingStats.totalTimeMs / 60000);
            const avgWpm = readingStats.totalTimeMs > 0
                ? Math.round((readingStats.totalWordsRead / readingStats.totalTimeMs) * 60000)
                : 0;

            let html = `
                <div><strong>Total words read:</strong> ${readingStats.totalWordsRead.toLocaleString()}</div>
                <div><strong>Total time:</strong> ${totalMinutes} minutes</div>
                <div><strong>Avg speed:</strong> ${avgWpm} WPM</div>
                <div><strong>Sessions:</strong> ${readingStats.sessions.length}</div>
            `;

            if (readingStats.sessions.length > 0) {
                html += '<div style="margin-top:10px;"><strong>Recent sessions:</strong></div>';
                const recent = readingStats.sessions.slice(-5).reverse();
                recent.forEach(s => {
                    const date = new Date(s.date).toLocaleDateString();
                    html += `<div style="font-size:12px;">${date}: ${s.wordsRead} words @ ${s.avgWpm} WPM</div>`;
                });
            }

            statsContent.innerHTML = html;
        }

        function clearStats() {
            if (!confirm('Clear all reading statistics?')) return;
            readingStats = { totalWordsRead: 0, totalTimeMs: 0, sessions: [] };
            localStorage.setItem('focusReaderStats', JSON.stringify(readingStats));
            updateStatsUI();
        }

        function togglePlay() {
            if (isPlaying) stop();
            else start();
        }

        function reset() {
            stop();
            currentIndex = 0;
            document.getElementById('display').innerHTML = '';
            updateProgress();
        }

        function skipBack() {
            currentIndex = Math.max(0, currentIndex - 10);
            if (words.length > 0 && currentIndex < words.length) {
                document.getElementById('display').innerHTML = displayWord(words[currentIndex]);
            }
            updateProgress();
        }

        function skipForward() {
            currentIndex = Math.min(words.length, currentIndex + 10);
            if (currentIndex >= words.length) {
                stop();
                document.getElementById('display').innerHTML = '(Finished)';
            } else {
                document.getElementById('display').innerHTML = displayWord(words[currentIndex]);
            }
            updateProgress();
        }

        function updateProgress() {
            const prog = document.getElementById('progress');
            const info = document.getElementById('info');
            if (words.length > 0) {
                prog.value = (currentIndex / words.length) * 100;
                const remainingWords = words.length - currentIndex;
                const currentWpm = getCurrentWpm();
                const minutesLeft = remainingWords / currentWpm;
                const wpmDisplay = autoRamp ? `${currentWpm} WPM (ramping)` : `${currentWpm} WPM`;
                info.textContent = `Words: ${currentIndex}/${words.length} | ${wpmDisplay} | Time left: ${minutesLeft.toFixed(1)} min`;
            }
        }

        function toggleFullscreen() {
            const elem = document.documentElement;
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => console.log(err));
            } else {
                document.exitFullscreen();
            }
        }

        document.getElementById('wpm-slider').addEventListener('input', (e) => {
            wpm = parseInt(e.target.value);
            document.getElementById('wpm-value').textContent = wpm;
            if (isPlaying) start(); // restart timer with new speed
        });

        document.getElementById('chunk-select').addEventListener('change', (e) => {
            chunkSize = parseInt(e.target.value);
        });

        document.getElementById('auto-ramp').addEventListener('change', (e) => {
            autoRamp = e.target.checked;
            document.getElementById('ramp-controls').style.display = autoRamp ? 'inline' : 'none';
            updateProgress();
        });

        document.getElementById('start-wpm').addEventListener('input', (e) => {
            startWpm = parseInt(e.target.value) || 200;
        });

        document.getElementById('target-wpm').addEventListener('input', (e) => {
            targetWpm = parseInt(e.target.value) || 600;
        });

        document.getElementById('theme-select').addEventListener('change', (e) => {
            document.body.className = e.target.value === 'dark' ? '' : `theme-${e.target.value}`;
        });

        document.getElementById('font-size').addEventListener('input', (e) => {
            fontSize = parseInt(e.target.value);
            document.getElementById('display').style.fontSize = fontSize + 'px';
        });

        document.getElementById('font-family').addEventListener('change', (e) => {
            fontFamily = e.target.value;
            document.getElementById('display').style.fontFamily = fontFamily;
        });

        document.getElementById('pivot-color').addEventListener('input', (e) => {
            pivotColor = e.target.value;
            // Refresh display if there's a current word showing
            if (words.length > 0 && currentIndex > 0 && currentIndex <= words.length) {
                const chunk = words.slice(Math.max(0, currentIndex - chunkSize), currentIndex);
                document.getElementById('display').innerHTML = displayChunk(chunk);
            }
        });

        document.getElementById('progress-container').addEventListener('click', (e) => {
            if (words.length === 0) return;
            const progress = document.getElementById('progress');
            const rect = progress.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const percentage = clickX / rect.width;
            currentIndex = Math.floor(percentage * words.length);
            currentIndex = Math.max(0, Math.min(currentIndex, words.length));
            if (currentIndex < words.length) {
                const chunk = words.slice(currentIndex, currentIndex + chunkSize);
                document.getElementById('display').innerHTML = displayChunk(chunk);
            }
            updateProgress();
        });

        // Drag and drop support
        const inputsDiv = document.getElementById('inputs');

        inputsDiv.addEventListener('dragover', (e) => {
            e.preventDefault();
            inputsDiv.classList.add('dragover');
        });

        inputsDiv.addEventListener('dragleave', (e) => {
            e.preventDefault();
            inputsDiv.classList.remove('dragover');
        });

        inputsDiv.addEventListener('drop', async (e) => {
            e.preventDefault();
            inputsDiv.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (!file) return;

            if (file.name.endsWith('.pdf')) {
                const arrayBuffer = await file.arrayBuffer();
                const text = await processPdf(arrayBuffer);
                loadWords(text);
            } else if (file.name.endsWith('.txt')) {
                const reader = new FileReader();
                reader.onload = (e) => loadWords(e.target.result);
                reader.readAsText(file);
            } else {
                alert('Please drop a .txt or .pdf file');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in textarea
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;

            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    wpm = Math.max(100, wpm - 50);
                    document.getElementById('wpm-slider').value = wpm;
                    document.getElementById('wpm-value').textContent = wpm;
                    if (isPlaying) start();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    wpm = Math.min(1000, wpm + 50);
                    document.getElementById('wpm-slider').value = wpm;
                    document.getElementById('wpm-value').textContent = wpm;
                    if (isPlaying) start();
                    break;
                case 'KeyR':
                    e.preventDefault();
                    reset();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    skipForward();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    skipBack();
                    break;
            }
        });

        // Click to pause/play
        document.getElementById('display').addEventListener('click', () => {
            if (words.length > 0) togglePlay();
        });

        // Touch swipe support for mobile
        let touchStartX = 0;
        let touchStartY = 0;
        const displayEl = document.getElementById('display');

        displayEl.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        displayEl.addEventListener('touchend', (e) => {
            if (words.length === 0) return;
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            // Only trigger if horizontal swipe is dominant and significant
            if (Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY)) {
                if (deltaX > 0) {
                    skipBack(); // Swipe right = go back
                } else {
                    skipForward(); // Swipe left = go forward
                }
            }
        }, { passive: true });

        async function processPdf(arrayBuffer) {
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                content.items.forEach(item => {
                    fullText += item.str + ' ';
                });
            }
            return fullText;
        }

        function loadWords(text, textId = null) {
            words = text.trim().split(/\s+/).filter(w => w.length > 0);
            currentIndex = 0;
            currentTextId = textId;
            document.getElementById('controls').style.display = 'block';
            document.getElementById('display').innerHTML = '';
            updateProgress();
            stop();

            // If loading from library, restore position
            if (textId) {
                const item = library.find(i => i.id === textId);
                if (item && item.position) {
                    currentIndex = Math.min(item.position, words.length);
                    if (currentIndex > 0 && currentIndex < words.length) {
                        const chunk = words.slice(currentIndex, currentIndex + chunkSize);
                        document.getElementById('display').innerHTML = displayChunk(chunk);
                    }
                    updateProgress();
                }
            }
        }

        function saveLibrary() {
            localStorage.setItem('focusReaderLibrary', JSON.stringify(library));
        }

        function saveCurrentPosition() {
            if (!currentTextId || words.length === 0) return;
            const item = library.find(i => i.id === currentTextId);
            if (item) {
                item.position = currentIndex;
                item.lastRead = Date.now();
                saveLibrary();
            }
        }

        function saveToLibrary() {
            if (words.length === 0) {
                alert('Load some text first!');
                return;
            }
            const title = prompt('Enter a title for this text:', 'Untitled');
            if (!title) return;

            const id = Date.now().toString();
            const text = words.join(' ');
            library.push({
                id,
                title,
                text,
                position: currentIndex,
                wordCount: words.length,
                created: Date.now(),
                lastRead: Date.now()
            });
            currentTextId = id;
            saveLibrary();
            updateLibraryUI();
            alert('Saved to library!');
        }

        function loadFromLibrary(id) {
            const item = library.find(i => i.id === id);
            if (item) {
                loadWords(item.text, item.id);
            }
        }

        function deleteFromLibrary(id) {
            if (!confirm('Delete this item from your library?')) return;
            library = library.filter(i => i.id !== id);
            saveLibrary();
            updateLibraryUI();
        }

        function updateLibraryUI() {
            const libraryList = document.getElementById('library-list');
            if (library.length === 0) {
                libraryList.innerHTML = '<em>No saved texts</em>';
                return;
            }
            libraryList.innerHTML = library.map(item => {
                const progress = item.position ? Math.round((item.position / item.wordCount) * 100) : 0;
                return `
                    <div style="margin:5px 0; padding:5px; background:rgba(128,128,128,0.2); border-radius:4px;">
                        <strong>${item.title}</strong> (${item.wordCount} words, ${progress}%)
                        <button onclick="loadFromLibrary('${item.id}')" style="margin:2px; padding:2px 6px;">Load</button>
                        <button onclick="deleteFromLibrary('${item.id}')" style="margin:2px; padding:2px 6px;">Delete</button>
                    </div>
                `;
            }).join('');
        }

        async function loadText() {
            const textarea = document.getElementById('text-input').value;
            if (textarea) {
                loadWords(textarea);
                return;
            }

            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            if (!file) {
                alert('Paste text or upload a file!');
                return;
            }

            if (file.name.endsWith('.pdf')) {
                const arrayBuffer = await file.arrayBuffer();
                const text = await processPdf(arrayBuffer);
                loadWords(text);
            } else {
                const reader = new FileReader();
                reader.onload = (e) => loadWords(e.target.result);
                reader.readAsText(file);
            }
        }

        // Initialize library UI on page load
        updateLibraryUI();
    </script>
</body>
</html>
